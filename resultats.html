<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<title>R√©sultats</title>
		<style>
			body {
				background: #000;
				color: #ccc;
			}
		</style>
	</head>
	<body>
		<h1>Liste des participants</h1>
		<ul id="results"></ul>
		<button id="clear">R√©initialiser</button>

		<script>
			// Protection simple avec mot de passe admin
			if (prompt("Mot de passe admin :") !== "mdpSecret") {
				alert("Acc√®s refus√©");
				document.body.innerHTML = ""; // Vide la page
			}

			const BASE_URL =
				window.location.hostname === "localhost"
					? "http://localhost:3000"
					: "https://calendrier-participatif.onrender.com";

			const list = document.getElementById("results");

			// ‚úÖ Factorisation dans une fonction pour pouvoir la rappeler
			function loadResults() {
				list.innerHTML = ""; // Vide la liste avant d'ajouter les nouvelles donn√©es

				fetch(`${BASE_URL}/all`)
					.then((res) => res.json())
					.then((data) => {
						if (data.length === 0) {
							list.innerHTML = "<li>Aucun participant trouv√©.</li>";
							return;
						}

						data.forEach((entry) => {
							const li = document.createElement("li");

							const formattedDates = entry.selectedDates.map((dateStr) => {
								const parts = dateStr.split("-");
								const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;

								if (entry.popularDates.includes(dateStr)) {
									return `<span style="color: green; font-weight: bold;">${formatted}</span>`;
								}
								return formatted;
							});

							li.innerHTML = `${entry.userName} ‚Üí ${formattedDates.join(
								" | "
							)}`;
							list.appendChild(li);
						});
					})
					.catch((err) => {
						console.error("Erreur :", err);
						list.innerHTML = "<li>Erreur lors du chargement des donn√©es.</li>";
					});
			}

			// üîÅ Chargement initial
			loadResults();

			// üîÅ R√©initialisation avec rechargement
			document.getElementById("clear").addEventListener("click", () => {
				if (confirm("Supprimer toutes les donn√©es du serveur ?")) {
					fetch(`${BASE_URL}/clear`, { method: "DELETE" })
						.then((res) => {
							if (res.ok) {
								alert("Donn√©es supprim√©es !");
								loadResults(); // üëà recharge proprement apr√®s suppression
							} else {
								alert("Erreur serveur");
							}
						})
						.catch((err) => {
							console.error(err);
							alert("Erreur de connexion au serveur.");
						});
				}
			});
		</script>
	</body>
</html>
