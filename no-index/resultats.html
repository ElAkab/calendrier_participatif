<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<title>R√©sultats</title>
		<style>
			body {
				background: #000;
				color: #ccc;
			}
		</style>
	</head>
	<body>
		<h2>Supprimer un participant</h2>
		<input
			type="text"
			id="deleteNameInput"
			placeholder="Pr√©nom exact √† supprimer"
		/>
		<button onclick="resetVotes()" id="deleteUserBtn">Supprimer</button>

		<h1>Liste des participants</h1>
		<ul id="results"></ul>
		<button id="clear">R√©initialiser</button>

		<script>
			// Protection simple avec mot de passe admin
			if (prompt("Mot de passe admin :") !== "mdpSecret") {
				alert("Acc√®s refus√©");
				document.body.innerHTML = ""; // Vide la page
			}

			const BASE_URL =
				window.location.hostname === "localhost"
					? "http://localhost:3000"
					: "https://calendrier-participatif.onrender.com";

			const list = document.getElementById("results");

			function formatDate(dateStr) {
				const date = new Date(dateStr);
				if (isNaN(date)) return dateStr; // Si la date est invalide

				const day = String(date.getDate()).padStart(2, "0");
				const month = String(date.getMonth() + 1).padStart(2, "0"); // Mois commence √† 0
				const year = date.getFullYear();

				return `${day}/${month}/${year}`;
			}

			// ‚úÖ Factorisation dans une fonction pour pouvoir la rappeler
			function loadResults() {
				list.innerHTML = "";

				fetch(`${BASE_URL}/votes`)
					.then((res) => res.json())
					.then((data) => {
						if (data.length === 0) {
							list.innerHTML = "<li>Aucun participant trouv√©.</li>";
							return;
						}

						data.forEach((entry) => {
							const li = document.createElement("li");

							const formattedDates = entry.selectedDates.map((dateStr) => {
								const formatted = formatDate(dateStr);

								if (entry.popularDates.includes(dateStr)) {
									return `<span style="color: green; font-weight: bold;">${formatted}</span>`;
								}
								return formatted;
							});

							li.innerHTML = `${entry.userName} ‚Üí ${formattedDates.join(
								" | "
							)}`;
							list.appendChild(li);
						});
					})
					.catch((err) => {
						console.error("Erreur :", err);
						list.innerHTML =
							"<li>Erreur lors du chargement des donn√©es.</li>" + err;
					});
			}

			// üîÅ Chargement initial
			loadResults();

			// üîÅ R√©initialisation globale
			const clearBtn = document.getElementById("clear");
			if (clearBtn) {
				clearBtn.addEventListener("click", () => {
					if (
						confirm(
							"Supprimer TOUTES les donn√©es du serveur ET r√©initialiser l'affichage ?"
						)
					) {
						fetch(`${BASE_URL}/clear`, { method: "DELETE" })
							.then((res) => {
								if (res.ok) {
									alert("Donn√©es supprim√©es !");
									loadResults();

									// R√©initialisation locale
									document
										.querySelectorAll(".dates li.selected")
										.forEach((li) => li.classList.remove("selected"));

									localStorage.removeItem("selectedDates");
									localStorage.removeItem("votesByDate");

									const nameInput = document.getElementById("userNameInput");
									if (nameInput) nameInput.value = "";

									const output = document.getElementById("output");
									if (output) output.innerHTML = "";
								} else {
									alert("Erreur serveur");
								}
							})
							.catch((err) => {
								console.error(err);
								alert("Erreur de connexion au serveur.");
							});
					}
				});
			}

			function resetVotes() {
				if (confirm("‚ö†Ô∏è Es-tu s√ªr de vouloir supprimer tous les votes ?")) {
					fetch("https://calendrier-participatif.onrender.com/clear", {
						method: "DELETE",
					})
						.then((res) => {
							if (!res.ok) throw new Error("Erreur lors de la suppression.");
							return res.text();
						})
						.then((msg) => {
							alert("‚úÖ Donn√©es supprim√©es !");
							// Recharge la page pour afficher les r√©sultats vides
							location.reload();
						})
						.catch((err) => {
							alert("‚ùå Une erreur est survenue : " + err.message);
						});
				}
			}

			// üîÅ Suppression d'un participant
			const deleteBtn = document.getElementById("deleteUserBtn");
			if (deleteBtn) {
				deleteBtn.addEventListener("click", () => {
					const name = document.getElementById("deleteNameInput").value.trim();
					if (!name) return alert("Veuillez entrer un pr√©nom.");

					if (confirm(`Supprimer toutes les donn√©es associ√©es √† "${name}" ?`)) {
						fetch(`${BASE_URL}/delete-user/${encodeURIComponent(name)}`, {
							method: "DELETE",
						})
							.then((res) => {
								if (res.ok) {
									alert(`Le participant "${name}" a √©t√© supprim√©.`);
									loadResults();
								} else {
									alert("Aucun utilisateur trouv√© ou erreur serveur.");
								}
							})
							.catch((err) => {
								console.error(err);
								alert("Erreur lors de la suppression.");
							});
					}
				});
			}
		</script>
	</body>
</html>
